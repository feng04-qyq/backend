# éƒ¨ç½²æŒ‡å— - wxf888.top

## ğŸ“‹ å‰ææ¡ä»¶

- å·²è´­ä¹°æœåŠ¡å™¨ï¼ˆæ¨è Ubuntu 22.04ï¼‰
- åŸŸå `wxf888.top` å·²æ·»åŠ åˆ° Cloudflare
- æœåŠ¡å™¨ IP åœ°å€å·²é…ç½®åœ¨ Cloudflare DNS
- æœåŠ¡å™¨å·²å®‰è£… Python 3.10+ å’Œ Node.js 18+

---

## ç¬¬ä¸€æ­¥ï¼šCloudflare DNS é…ç½®

### 1. ç™»å½• Cloudflare æ§åˆ¶å°

è®¿é—®ï¼šhttps://dash.cloudflare.com/

### 2. æ·»åŠ  DNS è®°å½•

é€‰æ‹©åŸŸå `wxf888.top` â†’ DNS â†’ è®°å½•ï¼Œæ·»åŠ ï¼š

| ç±»å‹ | åç§° | å†…å®¹ | ä»£ç†çŠ¶æ€ |
|------|------|------|----------|
| A | @ | ä½ çš„æœåŠ¡å™¨IP | âœ… å·²ä»£ç†ï¼ˆæ©™è‰²äº‘æœµï¼‰ |
| A | www | ä½ çš„æœåŠ¡å™¨IP | âœ… å·²ä»£ç†ï¼ˆæ©™è‰²äº‘æœµï¼‰ |
| A | api | ä½ çš„æœåŠ¡å™¨IP | âœ… å·²ä»£ç†ï¼ˆæ©™è‰²äº‘æœµï¼‰ |

**è¯´æ˜**ï¼š
- `@` è¡¨ç¤ºæ ¹åŸŸå `wxf888.top`
- `www` è¡¨ç¤º `www.wxf888.top`
- `api` è¡¨ç¤º `api.wxf888.top`ï¼ˆå¯é€‰ï¼Œç”¨äº API å­åŸŸåï¼‰

### 3. SSL/TLS è®¾ç½®

**Cloudflare æ§åˆ¶å°** â†’ SSL/TLS â†’ æ¦‚è¿°

- é€‰æ‹© **"å®Œå…¨"** æˆ– **"å®Œå…¨ï¼ˆä¸¥æ ¼ï¼‰"** æ¨¡å¼
- è¿™æ · Cloudflare ä¼šè‡ªåŠ¨æä¾› SSL è¯ä¹¦

---

## ç¬¬äºŒæ­¥ï¼šæœåŠ¡å™¨å‡†å¤‡

### 1. è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@ä½ çš„æœåŠ¡å™¨IP
# æˆ–
ssh user@ä½ çš„æœåŠ¡å™¨IP
```

### 2. æ›´æ–°ç³»ç»Ÿ

```bash
sudo apt update
sudo apt upgrade -y
```

### 3. å®‰è£…å¿…è¦è½¯ä»¶

```bash
# å®‰è£… Nginx
sudo apt install nginx -y

# å®‰è£… Python å’Œ pip
sudo apt install python3 python3-pip python3-venv -y

# å®‰è£… Node.js 18+ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# å®‰è£… PostgreSQLï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo apt install postgresql postgresql-contrib -y
sudo apt install libpq-dev -y

# å®‰è£… Gitï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo apt install git -y

# å®‰è£… PM2ï¼ˆç”¨äºè¿›ç¨‹ç®¡ç†ï¼‰
sudo npm install -g pm2
```

### 4. é˜²ç«å¢™é…ç½®

```bash
# å…è®¸ HTTP/HTTPS
sudo ufw allow 'Nginx Full'
sudo ufw allow 22  # SSH
sudo ufw enable
```

---

## ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åç«¯ï¼ˆFastAPIï¼‰

### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
sudo mkdir -p /var/www/wxf888.top
sudo chown $USER:$USER /var/www/wxf888.top
cd /var/www/wxf888.top
```

### 2. ä¸Šä¼ åç«¯ä»£ç 

**æ–¹å¼ä¸€ï¼šä½¿ç”¨ Git**

```bash
git clone ä½ çš„ä»“åº“åœ°å€ backend
cd backend
```

**æ–¹å¼äºŒï¼šä½¿ç”¨ SCPï¼ˆä»æœ¬åœ°ï¼‰**

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆWindows PowerShell æˆ– CMDï¼‰
scp -r C:\Users\WXF\Desktop\bybit\live_trading_system\* user@æœåŠ¡å™¨IP:/var/www/wxf888.top/backend/
```

### 3. åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ

```bash
cd /var/www/wxf888.top/backend
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements_production.txt
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

```bash
nano .env
```

**`.env` æ–‡ä»¶å†…å®¹**ï¼š

```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://trading_user:ä½ çš„å¯†ç @localhost:5432/bybit_trading

# JWT é…ç½®
JWT_SECRET_KEY=ä½ çš„éšæœºå¯†é’¥ï¼ˆè‡³å°‘32å­—ç¬¦ï¼‰

# åŸŸåé…ç½®
DOMAIN=wxf888.top
FRONTEND_URL=https://wxf888.top
BACKEND_URL=https://api.wxf888.top

# å…¶ä»–é…ç½®ï¼ˆå¯é€‰ï¼‰
MASTER_PASSWORD=ä½ çš„ä¸»å¯†ç 
MASTER_SALT=ä½ çš„ç›å€¼
```

### 5. åˆå§‹åŒ–æ•°æ®åº“

```bash
python initialize_v3.3_clean.py
```

### 6. æµ‹è¯•åç«¯å¯åŠ¨

```bash
source venv/bin/activate
uvicorn api_server_unified:app --host 0.0.0.0 --port 8000
```

æŒ‰ `Ctrl+C` åœæ­¢ï¼Œç¡®è®¤å¯ä»¥å¯åŠ¨å³å¯ã€‚

---

## ç¬¬å››æ­¥ï¼šéƒ¨ç½²å‰ç«¯ï¼ˆNext.jsï¼‰

### 1. ä¸Šä¼ å‰ç«¯ä»£ç 

```bash
cd /var/www/wxf888.top
# å¦‚æœä½¿ç”¨ Git
git clone ä½ çš„å‰ç«¯ä»“åº“åœ°å€ frontend
# æˆ–ä½¿ç”¨ SCP ä¸Šä¼ 
```

### 2. å®‰è£…ä¾èµ–å¹¶æ„å»º

```bash
cd /var/www/wxf888.top/frontend
npm install
```

### 3. é…ç½®å‰ç«¯ç¯å¢ƒå˜é‡

```bash
nano .env.production
```

**`.env.production` æ–‡ä»¶å†…å®¹**ï¼š

```env
NEXT_PUBLIC_API_URL=https://api.wxf888.top
# æˆ–å¦‚æœä½¿ç”¨åŒä¸€åŸŸå
NEXT_PUBLIC_API_URL=https://wxf888.top
```

### 4. æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
npm run build
```

### 5. æµ‹è¯•å‰ç«¯å¯åŠ¨

```bash
npm start
```

è®¿é—® `http://æœåŠ¡å™¨IP:3000` æµ‹è¯•ï¼Œç¡®è®¤æ­£å¸¸åæŒ‰ `Ctrl+C` åœæ­¢ã€‚

---

## ç¬¬äº”æ­¥ï¼šé…ç½® Nginx åå‘ä»£ç†

### 1. åˆ›å»º Nginx é…ç½®æ–‡ä»¶

```bash
sudo nano /etc/nginx/sites-available/wxf888.top
```

**é…ç½®æ–‡ä»¶å†…å®¹**ï¼ˆä½¿ç”¨åŒä¸€åŸŸåï¼ŒAPI é€šè¿‡ `/api` è·¯å¾„ï¼‰ï¼š

```nginx
# å‰ç«¯ï¼ˆNext.jsï¼‰
server {
    listen 80;
    server_name wxf888.top www.wxf888.top;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name wxf888.top www.wxf888.top;

    # SSL è¯ä¹¦ï¼ˆç”± Cloudflare æä¾›ï¼ŒNginx ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
    ssl_certificate /etc/ssl/certs/cloudflare.crt;  # Cloudflare è‡ªåŠ¨ç®¡ç†
    ssl_certificate_key /etc/ssl/private/cloudflare.key;

    # æˆ–è€…ä½¿ç”¨ Let's Encryptï¼ˆæ¨èï¼‰
    # ssl_certificate /etc/letsencrypt/live/wxf888.top/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/wxf888.top/privkey.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # å‰ç«¯é™æ€æ–‡ä»¶å’Œ Next.js
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # CORS å¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # WebSocket æ”¯æŒ
    location /ws {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # æ—¥å¿—
    access_log /var/log/nginx/wxf888.top.access.log;
    error_log /var/log/nginx/wxf888.top.error.log;
}
```

**æˆ–è€…ä½¿ç”¨å­åŸŸåæ–¹æ¡ˆ**ï¼ˆAPI ç‹¬ç«‹åŸŸåï¼‰ï¼š

```nginx
# å‰ç«¯
server {
    listen 443 ssl http2;
    server_name wxf888.top www.wxf888.top;
    
    # SSL é…ç½®...
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        # ... å…¶ä»–é…ç½®
    }
}

# åç«¯ API
server {
    listen 443 ssl http2;
    server_name api.wxf888.top;
    
    # SSL é…ç½®...
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        # ... å…¶ä»–é…ç½®
    }
    
    location /ws {
        proxy_pass http://127.0.0.1:8000;
        # WebSocket é…ç½®...
    }
}
```

### 2. å¯ç”¨ç«™ç‚¹

```bash
sudo ln -s /etc/nginx/sites-available/wxf888.top /etc/nginx/sites-enabled/
sudo nginx -t  # æµ‹è¯•é…ç½®
sudo systemctl reload nginx
```

### 3. å®‰è£… SSL è¯ä¹¦ï¼ˆä½¿ç”¨ Let's Encryptï¼Œæ¨èï¼‰

```bash
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d wxf888.top -d www.wxf888.top
# å¦‚æœä½¿ç”¨ API å­åŸŸå
sudo certbot --nginx -d api.wxf888.top
```

**æˆ–è€…ä½¿ç”¨ Cloudflare Origin Certificate**ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰ï¼š

åœ¨ Cloudflare æ§åˆ¶å° â†’ SSL/TLS â†’ æºæœåŠ¡å™¨ â†’ åˆ›å»ºè¯ä¹¦ï¼Œç„¶åé…ç½®åˆ° Nginxã€‚

---

## ç¬¬å…­æ­¥ï¼šé…ç½® PM2 è¿›ç¨‹ç®¡ç†

### 1. å¯åŠ¨åç«¯

```bash
cd /var/www/wxf888.top/backend
source venv/bin/activate

# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start uvicorn --name "backend" -- --host 0.0.0.0 --port 8000 api_server_unified:app
```

**æˆ–åˆ›å»º PM2 é…ç½®æ–‡ä»¶** `ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'trading-backend',
    script: 'uvicorn',
    args: 'api_server_unified:app --host 0.0.0.0 --port 8000',
    cwd: '/var/www/wxf888.top/backend',
    interpreter: '/var/www/wxf888.top/backend/venv/bin/python3',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

ç„¶åå¯åŠ¨ï¼š

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # è®¾ç½®å¼€æœºè‡ªå¯
```

### 2. å¯åŠ¨å‰ç«¯

```bash
cd /var/www/wxf888.top/frontend
pm2 start npm --name "frontend" -- start
pm2 save
```

**æˆ–ä½¿ç”¨ PM2 é…ç½®**ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'trading-frontend',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/wxf888.top/frontend',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
```

### 3. æŸ¥çœ‹ PM2 çŠ¶æ€

```bash
pm2 status
pm2 logs
pm2 monit
```

---

## ç¬¬ä¸ƒæ­¥ï¼šæ›´æ–°åç«¯ CORS é…ç½®

ç¼–è¾‘ `api_server_unified.py`ï¼š

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://wxf888.top",
        "https://www.wxf888.top",
        "https://api.wxf888.top",  # å¦‚æœä½¿ç”¨å­åŸŸå
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

é‡å¯åç«¯ï¼š

```bash
pm2 restart backend
```

---

## ç¬¬å…«æ­¥ï¼šæµ‹è¯•éƒ¨ç½²

### 1. æµ‹è¯•å‰ç«¯

è®¿é—®ï¼š`https://wxf888.top`

### 2. æµ‹è¯• API

```bash
curl https://wxf888.top/api/health
# æˆ–
curl https://api.wxf888.top/health
```

### 3. æµ‹è¯•ç™»å½•

è®¿é—® `https://wxf888.top/login`ï¼Œä½¿ç”¨é»˜è®¤è´¦å·ï¼š
- ç”¨æˆ·åï¼š`admin`
- å¯†ç ï¼š`admin123`

---

## å¸¸è§é—®é¢˜

### 1. SSL è¯ä¹¦é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ Cloudflare SSL/TLS è®¾ç½®ä¸º "å®Œå…¨" æ¨¡å¼ï¼Œæˆ–ä½¿ç”¨ Let's Encrypt è¯ä¹¦ã€‚

### 2. API è¯·æ±‚å¤±è´¥

**æ£€æŸ¥é¡¹**ï¼š
- Nginx é…ç½®æ˜¯å¦æ­£ç¡®
- åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`pm2 status`
- æŸ¥çœ‹æ—¥å¿—ï¼š`pm2 logs backend`

### 3. å‰ç«¯æ— æ³•è¿æ¥åç«¯

**æ£€æŸ¥**ï¼š
- `.env.production` ä¸­çš„ `NEXT_PUBLIC_API_URL` æ˜¯å¦æ­£ç¡®
- æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS é”™è¯¯
- åç«¯ CORS é…ç½®æ˜¯å¦åŒ…å«å‰ç«¯åŸŸå

### 4. WebSocket è¿æ¥å¤±è´¥

**æ£€æŸ¥**ï¼š
- Nginx æ˜¯å¦æ­£ç¡®é…ç½®äº† `/ws` è·¯å¾„çš„ WebSocket æ”¯æŒ
- åç«¯ WebSocket ç«¯å£æ˜¯å¦æ­£ç¡®

---

## ç»´æŠ¤å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs backend
pm2 logs frontend

# é‡å¯æœåŠ¡
pm2 restart backend
pm2 restart frontend

# æ›´æ–°ä»£ç åé‡å¯
cd /var/www/wxf888.top/backend
git pull
source venv/bin/activate
pip install -r requirements_production.txt
pm2 restart backend

cd /var/www/wxf888.top/frontend
git pull
npm install
npm run build
pm2 restart frontend

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/wxf888.top.access.log
sudo tail -f /var/log/nginx/wxf888.top.error.log
```

---

## å®‰å…¨å»ºè®®

1. **æ›´æ”¹é»˜è®¤å¯†ç **ï¼šç™»å½•åç«‹å³ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
2. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°ç³»ç»Ÿä¾èµ–å’Œä»£ç 
3. **å¤‡ä»½æ•°æ®åº“**ï¼šå®šæœŸå¤‡ä»½ PostgreSQL æ•°æ®åº“
4. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥ PM2 å’Œ Nginx æ—¥å¿—
5. **é˜²ç«å¢™è§„åˆ™**ï¼šåªå¼€æ”¾å¿…è¦ç«¯å£

---

## å¿«é€Ÿéƒ¨ç½²è„šæœ¬ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `deploy.sh`ï¼š

```bash
#!/bin/bash
cd /var/www/wxf888.top/backend
source venv/bin/activate
git pull
pip install -r requirements_production.txt
pm2 restart backend

cd /var/www/wxf888.top/frontend
git pull
npm install
npm run build
pm2 restart frontend

echo "éƒ¨ç½²å®Œæˆï¼"
```

ä½¿ç”¨ï¼š

```bash
chmod +x deploy.sh
./deploy.sh
```

---

**éƒ¨ç½²å®Œæˆåï¼Œä½ çš„ç³»ç»Ÿå°†é€šè¿‡ `https://wxf888.top` è®¿é—®ï¼**

